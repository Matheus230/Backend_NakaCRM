# üöÄ Backend NakaCRM

Sistema CRM (Customer Relationship Management) completo desenvolvido com Spring Boot 3.3.5 e Java 21, focado em gest√£o de leads, pipeline de vendas e relacionamento com clientes.

[![Java](https://img.shields.io/badge/Java-21-orange.svg)](https://www.oracle.com/java/)
[![Spring Boot](https://img.shields.io/badge/Spring%20Boot-3.3.5-brightgreen.svg)](https://spring.io/projects/spring-boot)
[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-16-blue.svg)](https://www.postgresql.org/)
[![License](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

---

## üìã √çndice

- [Funcionalidades](#-funcionalidades)
- [Arquitetura](#-arquitetura)
- [Tecnologias](#-tecnologias)
- [Pr√©-requisitos](#-pr√©-requisitos)
- [Instala√ß√£o](#-instala√ß√£o)
- [Configura√ß√£o](#-configura√ß√£o)
- [Execu√ß√£o](#-execu√ß√£o)
- [API Documentation](#-api-documentation)
- [Banco de Dados](#-banco-de-dados)
- [Seguran√ßa](#-seguran√ßa)
- [Performance](#-performance)
- [Estrutura do Projeto](#-estrutura-do-projeto)
- [Testes](#-testes)
- [Deploy](#-deploy)
- [Contribuindo](#-contribuindo)

---

## ‚ú® Funcionalidades

### Gest√£o de Clientes/Leads
- ‚úÖ CRUD completo de clientes
- ‚úÖ Funil de vendas: NOVO ‚Üí CONTATADO ‚Üí QUALIFICADO ‚Üí OPORTUNIDADE ‚Üí CLIENTE/PERDIDO
- ‚úÖ Rastreamento de origem (Google Forms, Landing Page, Manual)
- ‚úÖ Timeline completa de intera√ß√µes
- ‚úÖ Filtros avan√ßados e pagina√ß√£o

### Rastreamento UTM
- ‚úÖ Captura de par√¢metros UTM (source, medium, campaign)
- ‚úÖ User agent tracking
- ‚úÖ Analytics de origem de leads

### Gest√£o de Produtos
- ‚úÖ Cat√°logo de produtos/servi√ßos
- ‚úÖ Tipos de cobran√ßa (√önico, Mensal, Anual)
- ‚úÖ Formas de pagamento (Cart√£o, PIX, Boleto)
- ‚úÖ Relacionamento M:N com clientes (interesses)

### Intera√ß√µes
- ‚úÖ Timeline de comunica√ß√µes (Email, Telefone, WhatsApp)
- ‚úÖ Registro autom√°tico de eventos
- ‚úÖ Notas internas
- ‚úÖ Metadados JSONB para flexibilidade

### Dashboard & Analytics
- ‚úÖ M√©tricas de convers√£o
- ‚úÖ Funil de vendas visual
- ‚úÖ Taxa de convers√£o por origem
- ‚úÖ Leads para follow-up
- ‚úÖ Hot leads do dia

### Autentica√ß√£o & Autoriza√ß√£o
- ‚úÖ JWT com refresh token
- ‚úÖ OAuth2 (Google)
- ‚úÖ RBAC (Admin, Vendedor)
- ‚úÖ Sess√µes stateless

### Email Marketing
- ‚úÖ Envio ass√≠ncrono de emails
- ‚úÖ Templates HTML responsivos
- ‚úÖ Boas-vindas, follow-up, promocionais
- ‚úÖ Integra√ß√£o com MailHog (dev)

---

## üèóÔ∏è Arquitetura

### Padr√µes Utilizados
- **Layered Architecture**: Controller ‚Üí Service ‚Üí Repository
- **DTO Pattern**: Separa√ß√£o entre entidades e transfer√™ncia de dados
- **Repository Pattern**: Abstra√ß√£o de acesso a dados
- **Dependency Injection**: Invers√£o de controle com Spring
- **Builder Pattern**: Lombok para constru√ß√£o de objetos
- **Exception Handling**: Hierarquia de exce√ß√µes customizadas

### Princ√≠pios SOLID
- ‚úÖ Single Responsibility Principle
- ‚úÖ Open/Closed Principle
- ‚úÖ Liskov Substitution Principle
- ‚úÖ Interface Segregation Principle
- ‚úÖ Dependency Inversion Principle

---

## üõ†Ô∏è Tecnologias

### Core
- **Java 21** - LTS version com Virtual Threads e Pattern Matching
- **Spring Boot 3.3.5** - Framework principal
- **Spring Data JPA** - Persist√™ncia de dados
- **Spring Security** - Autentica√ß√£o e autoriza√ß√£o
- **Spring Cache** - Abstra√ß√£o de cache

### Database
- **PostgreSQL 16** - Banco relacional
- **Flyway** - Versionamento de schema
- **HikariCP** - Connection pooling

### Security
- **JWT (jjwt 0.12.6)** - Tokens de autentica√ß√£o
- **BCrypt** - Hash de senhas
- **OAuth2 Client** - Integra√ß√£o com Google

### Performance
- **Caffeine 3.1.8** - Cache in-memory de alta performance
- **Query Optimization** - Fetch joins e queries nativas

### Utilities
- **Lombok 1.18.30** - Redu√ß√£o de boilerplate
- **Caelum Stella 2.1.6** - Valida√ß√£o CPF/CNPJ
- **Jackson** - Serializa√ß√£o JSON
- **Apache Commons Lang** - Utilidades

### Documentation
- **SpringDoc OpenAPI 3** - Documenta√ß√£o interativa Swagger
- **JavaDoc** - Documenta√ß√£o de c√≥digo

### DevOps
- **Docker Compose** - Orquestra√ß√£o de containers
- **Maven** - Build e gerenciamento de depend√™ncias
- **Actuator** - Monitoramento e health checks

### Testing
- **JUnit 5** - Testes unit√°rios
- **Testcontainers** - Testes de integra√ß√£o
- **Mockito** - Mocking
- **H2** - Banco em mem√≥ria para testes

---

## üì¶ Pr√©-requisitos

- **Java 21+** ([Download](https://www.oracle.com/java/technologies/javase/jdk21-archive-downloads.html))
- **Maven 3.8+** ([Download](https://maven.apache.org/download.cgi))
- **Docker & Docker Compose** ([Download](https://www.docker.com/products/docker-desktop/))
- **PostgreSQL 16** (opcional - pode usar Docker)

### Verificando instala√ß√£o

```bash
java -version   # Java 21+
mvn -version    # Maven 3.8+
docker -v       # Docker 20+
```

---

## üöÄ Instala√ß√£o

### 1. Clone o reposit√≥rio

```bash
git clone https://github.com/nakacorp/backend-nakacrm.git
cd backend-nakacrm
```

### 2. Configure as vari√°veis de ambiente

```bash
# Copie o arquivo de exemplo
cp .env.example .env

# Edite o arquivo .env com suas configura√ß√µes
nano .env
```

**Exemplo de .env:**

```properties
# Database
DB_HOST=localhost
DB_PORT=5432
DB_NAME=crm_db
DB_USER=crm_user
DB_PASSWORD=crm_password

# JWT (CR√çTICO: gere uma chave forte!)
JWT_SECRET=$(openssl rand -hex 64)
JWT_EXPIRATION=86400000
JWT_REFRESH_EXPIRATION=604800000

# OAuth2 Google
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# Email
MAIL_HOST=localhost
MAIL_PORT=1025

# CORS
CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173
```

### 3. Inicie o banco de dados

```bash
# Com Docker Compose (recomendado)
docker-compose up -d crm-postgres

# Ou manualmente com PostgreSQL local
createdb crm_db
createuser crm_user
```

### 4. Compile o projeto

```bash
mvn clean install
```

---

## ‚öôÔ∏è Configura√ß√£o

### Perfis de Ambiente

A aplica√ß√£o suporta diferentes perfis:

- **dev** (padr√£o): Desenvolvimento local
- **prod**: Produ√ß√£o
- **docker**: Execu√ß√£o em container

Ative um perfil espec√≠fico:

```bash
mvn spring-boot:run -Dspring-boot.run.profiles=prod
```

### Configura√ß√£o do Flyway

As migrations s√£o aplicadas automaticamente na inicializa√ß√£o:

```
src/main/resources/db/migration/
‚îú‚îÄ‚îÄ V1__initial_schema.sql
‚îú‚îÄ‚îÄ V2__add_indexes.sql
‚îú‚îÄ‚îÄ V3__add_triggers.sql
‚îî‚îÄ‚îÄ V4__add_views.sql
```

### Configura√ß√£o de Cache

Caches configurados no `CacheConfig.java`:

| Cache | TTL | Max Size | Uso |
|-------|-----|----------|-----|
| produtos | 1h | 500 | Listagem de produtos |
| clientes | 15min | 1000 | Dados de clientes |
| dashboard-stats | 5min | 100 | M√©tricas do dashboard |

---

## üèÉ Execu√ß√£o

### Desenvolvimento Local

```bash
# Inicia todos os servi√ßos (DB, MailHog, PgAdmin)
./dev.sh

# Ou manualmente:
docker-compose up -d
mvn spring-boot:run
```

A aplica√ß√£o estar√° dispon√≠vel em:
- **API**: http://localhost:8080/api
- **Swagger**: http://localhost:8080/api/swagger-ui/index.html
- **Actuator**: http://localhost:8080/api/actuator/health
- **MailHog**: http://localhost:8025 (captura de emails)
- **PgAdmin**: http://localhost:5050 (gerenciamento DB)

### Modo Produ√ß√£o

```bash
# Build
mvn clean package -DskipTests

# Execute o JAR
java -jar target/backend.jar \
  --spring.profiles.active=prod \
  -Djwt.secret=$JWT_SECRET \
  -Dspring.datasource.url=$DATABASE_URL
```

### Docker

```bash
# Build da imagem
docker build -t nakacrm-backend .

# Execute
docker run -p 8080:8080 \
  -e JWT_SECRET=$JWT_SECRET \
  -e DB_HOST=postgres \
  nakacrm-backend
```

---

## üìö API Documentation

### Swagger UI

Acesse a documenta√ß√£o interativa em:
```
http://localhost:8080/api/swagger-ui/index.html
```

### Autentica√ß√£o

#### 1. Login

```bash
POST /api/auth/login
Content-Type: application/json

{
  "email": "admin@empresa.com",
  "senha": "admin123"
}

# Resposta:
{
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
  "tipo": "Bearer",
  "expiresIn": 86400000
}
```

#### 2. Usar o Token

```bash
GET /api/clientes
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

### Endpoints Principais

| M√©todo | Endpoint | Descri√ß√£o | Auth |
|--------|----------|-----------|------|
| **Auth** ||||
| POST | `/auth/login` | Login | ‚ùå |
| POST | `/auth/register` | Registro | ‚ùå |
| POST | `/auth/refresh` | Refresh token | ‚úÖ |
| **Clientes** ||||
| GET | `/clientes` | Listar clientes | ‚úÖ |
| GET | `/clientes/{id}` | Buscar por ID | ‚úÖ |
| POST | `/clientes` | Criar cliente | ‚úÖ |
| PUT | `/clientes/{id}` | Atualizar cliente | ‚úÖ |
| PATCH | `/clientes/{id}/status` | Atualizar status | ‚úÖ |
| DELETE | `/clientes/{id}` | Deletar cliente | ‚úÖ ADMIN |
| **Produtos** ||||
| GET | `/produtos` | Listar produtos | ‚úÖ |
| POST | `/produtos` | Criar produto | ‚úÖ |
| **Dashboard** ||||
| GET | `/dashboard/stats` | Estat√≠sticas gerais | ‚úÖ |
| GET | `/dashboard/conversion-rate` | Taxa de convers√£o | ‚úÖ |
| GET | `/dashboard/leads/hot-today` | Leads quentes | ‚úÖ |

### Exemplos de Uso

#### Criar Cliente

```bash
curl -X POST http://localhost:8080/api/clientes \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "nome": "Jo√£o Silva",
    "email": "joao@example.com",
    "telefone": "(11) 98765-4321",
    "empresa": "Empresa XYZ",
    "origemLead": "LANDING_PAGE",
    "statusLead": "NOVO"
  }'
```

#### Filtrar Clientes

```bash
# Com pagina√ß√£o e ordena√ß√£o
curl -X GET "http://localhost:8080/api/clientes?page=0&size=10&sortBy=createdAt&sortDirection=DESC" \
  -H "Authorization: Bearer $TOKEN"
```

---

## üóÑÔ∏è Banco de Dados

### Modelo Relacional

```
tb_usuario (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ< (N) tb_interacao_cliente
                              ‚îÇ
                              ‚îÇ
tb_produto (N) ‚îÄ‚îÄ<>‚îÄ‚îÄ (N) tb_cliente_interesse
                              ‚îÇ
                              ‚îÇ
tb_cliente (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ< (N) tb_cliente_interesse
     ‚îÇ
     ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ< (1) tb_lead_origem
     ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ< (N) tb_interacao_cliente
```

### Entidades

#### Cliente
- **PK**: id_cliente (BIGINT)
- **Campos**: nome, email, telefone, empresa, cargo, cidade, estado, CEP
- **Enums**: origem_lead, status_lead
- **Timestamps**: data_primeiro_contato, data_ultima_interacao, created_at, updated_at

#### Produto
- **PK**: id_produto (BIGINT)
- **Campos**: nome, descricao, categoria, preco, ativo
- **Enums**: tipo_cobranca, tipo_pagamento

#### Usuario
- **PK**: id_usuario (BIGINT)
- **Campos**: nome, email, senha_hash, ativo, google_id
- **Enum**: tipo_usuario (ADMIN, VENDEDOR)

### Migrations

Execute migrations manualmente:

```bash
mvn flyway:migrate
```

Criar nova migration:

```bash
# Crie arquivo em src/main/resources/db/migration/
# Padr√£o: V{version}__{description}.sql
# Exemplo: V5__add_cpf_column.sql
```

---

## üîí Seguran√ßa

### Boas Pr√°ticas Implementadas

‚úÖ **Senhas com BCrypt** (cost factor: 12)
‚úÖ **JWT com assinatura HMAC-SHA256**
‚úÖ **Secrets externalizados** (vari√°veis de ambiente)
‚úÖ **CORS configur√°vel** por ambiente
‚úÖ **HTTPS em produ√ß√£o** (recomendado)
‚úÖ **Rate limiting** (TODO)
‚úÖ **SQL Injection** prevenido (JPA/Hibernate)
‚úÖ **XSS** mitigado (JSON encoding autom√°tico)

### Tokens JWT

- **Access Token**: 24 horas (86400000ms)
- **Refresh Token**: 7 dias (604800000ms)
- **Algoritmo**: HS256
- **Claims**: userId, email, roles

### Roles e Permiss√µes

| Endpoint | ADMIN | VENDEDOR |
|----------|-------|----------|
| GET /clientes | ‚úÖ | ‚úÖ |
| POST /clientes | ‚úÖ | ‚úÖ |
| DELETE /clientes | ‚úÖ | ‚ùå |
| GET /actuator | ‚úÖ | ‚ùå |

---

## ‚ö° Performance

### Otimiza√ß√µes Implementadas

#### 1. **Cache com Caffeine**
- Produtos em cache por 1 hora
- Stats do dashboard por 5 minutos
- Evict autom√°tico em opera√ß√µes de escrita

#### 2. **Query Optimization**
```java
// Fetch Joins para evitar N+1
@Query("SELECT c FROM Cliente c " +
       "LEFT JOIN FETCH c.leadOrigem " +
       "LEFT JOIN FETCH c.interesses " +
       "WHERE c.id = :id")
Optional<Cliente> findByIdWithRelations(@Param("id") Long id);
```

#### 3. **Pagina√ß√£o**
Todos os endpoints de listagem suportam pagina√ß√£o:
```
GET /clientes?page=0&size=20
```

#### 4. **√çndices de Banco**
- status_lead, origem_lead (clientes)
- categoria, ativo (produtos)
- created_at para ordena√ß√£o temporal

#### 5. **Connection Pooling (HikariCP)**
```properties
spring.datasource.hikari.maximum-pool-size=20
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.connection-timeout=30000
```

### M√©tricas

Dispon√≠veis via Actuator:

```bash
# M√©tricas de cache
curl http://localhost:8080/api/actuator/metrics/cache.gets

# Health check
curl http://localhost:8080/api/actuator/health
```

---

## üìÅ Estrutura do Projeto

```
src/main/java/com/nakacorp/backend/
‚îú‚îÄ‚îÄ config/                 # Configura√ß√µes Spring
‚îÇ   ‚îú‚îÄ‚îÄ BeanConfig.java
‚îÇ   ‚îú‚îÄ‚îÄ CacheConfig.java
‚îÇ   ‚îî‚îÄ‚îÄ SwaggerConfig.java
‚îú‚îÄ‚îÄ controller/             # REST Controllers
‚îÇ   ‚îú‚îÄ‚îÄ ClienteController.java
‚îÇ   ‚îú‚îÄ‚îÄ DashboardController.java
‚îÇ   ‚îî‚îÄ‚îÄ GlobalExceptionHandler.java
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ req/               # Request DTOs
‚îÇ   ‚îî‚îÄ‚îÄ res/               # Response DTOs
‚îú‚îÄ‚îÄ exception/             # Exce√ß√µes customizadas
‚îÇ   ‚îú‚îÄ‚îÄ BusinessException.java
‚îÇ   ‚îú‚îÄ‚îÄ ResourceNotFoundException.java
‚îÇ   ‚îî‚îÄ‚îÄ DuplicateResourceException.java
‚îú‚îÄ‚îÄ model/                 # Entidades JPA
‚îÇ   ‚îú‚îÄ‚îÄ Cliente.java
‚îÇ   ‚îú‚îÄ‚îÄ Usuario.java
‚îÇ   ‚îú‚îÄ‚îÄ Produto.java
‚îÇ   ‚îî‚îÄ‚îÄ enums/
‚îú‚îÄ‚îÄ repository/            # JPA Repositories
‚îÇ   ‚îú‚îÄ‚îÄ ClienteRepository.java
‚îÇ   ‚îî‚îÄ‚îÄ ProdutoRepository.java
‚îú‚îÄ‚îÄ security/              # Seguran√ßa JWT
‚îÇ   ‚îú‚îÄ‚îÄ JwtTokenProvider.java
‚îÇ   ‚îú‚îÄ‚îÄ SecurityConfig.java
‚îÇ   ‚îî‚îÄ‚îÄ JwtAuthenticationFilter.java
‚îú‚îÄ‚îÄ service/               # L√≥gica de neg√≥cio
‚îÇ   ‚îú‚îÄ‚îÄ ClienteService.java
‚îÇ   ‚îú‚îÄ‚îÄ DashboardService.java
‚îÇ   ‚îî‚îÄ‚îÄ EmailService.java
‚îî‚îÄ‚îÄ validation/            # Validadores customizados
    ‚îú‚îÄ‚îÄ CPFValidator.java
    ‚îî‚îÄ‚îÄ CNPJValidator.java

src/main/resources/
‚îú‚îÄ‚îÄ db/migration/          # Flyway migrations
‚îÇ   ‚îú‚îÄ‚îÄ V1__initial_schema.sql
‚îÇ   ‚îú‚îÄ‚îÄ V2__add_indexes.sql
‚îÇ   ‚îî‚îÄ‚îÄ V3__add_triggers.sql
‚îú‚îÄ‚îÄ application.properties
‚îî‚îÄ‚îÄ application-dev.yml
```

---

## üß™ Testes

### Executar Testes

```bash
# Todos os testes
mvn test

# Apenas testes unit√°rios
mvn test -Dtest="*Test"

# Apenas testes de integra√ß√£o
mvn test -Dtest="*IT"

# Com coverage
mvn test jacoco:report
```

### Coverage Report

Relat√≥rio gerado em: `target/site/jacoco/index.html`

Meta: **80%+ de cobertura**

---

## üö¢ Deploy

### Heroku

```bash
# Criar app
heroku create nakacrm-backend

# Adicionar PostgreSQL
heroku addons:create heroku-postgresql:essential-0

# Configurar vari√°veis
heroku config:set JWT_SECRET=$(openssl rand -hex 64)

# Deploy
git push heroku main
```

### AWS (Elastic Beanstalk)

```bash
# Criar environment
eb init -p java-21 nakacrm-backend

# Deploy
eb create nakacrm-backend-env
eb deploy
```

### Docker Production

```dockerfile
FROM eclipse-temurin:21-jre-alpine
WORKDIR /app
COPY target/backend.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

---

## üìù Contribuindo

1. Fork o projeto
2. Crie uma branch para sua feature (`git checkout -b feature/AmazingFeature`)
3. Commit suas mudan√ßas (`git commit -m 'Add some AmazingFeature'`)
4. Push para a branch (`git push origin feature/AmazingFeature`)
5. Abra um Pull Request

### Padr√µes de C√≥digo

- ‚úÖ Seguir conven√ß√µes Java
- ‚úÖ Adicionar JavaDoc em m√©todos p√∫blicos
- ‚úÖ Escrever testes para novas funcionalidades
- ‚úÖ Manter cobertura acima de 80%
- ‚úÖ Usar Lombok para reduzir boilerplate

---

## üìÑ Licen√ßa


---

## üë• Autores

**NakaCorp** - *Desenvolvimento Inicial*

---

## üôè Agradecimentos

- Spring Boot Team
- PostgreSQL Community
- Caelum Stella (valida√ß√£o CPF/CNPJ)
- Todos os contribuidores!

---

## üìû Suporte

- üìß Email: *********
- üìù Issues: [GitHub Issues](https://github.com/nakacorp/backend-nakacrm/issues)
- üìñ Wiki: [GitHub Wiki](https://github.com/nakacorp/backend-nakacrm/wiki)

---
